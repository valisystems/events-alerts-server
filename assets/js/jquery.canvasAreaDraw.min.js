!function(a){a.fn.canvasAreaDraw=function(a){this.each(function(c,d){b.apply(d,[c,d,a])})};var b=function(b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;h=a.extend({imageUrl:a(this).attr("data-image-url")},e),f=a(this).val().length?a(this).val().split(",").map(function(a){return parseInt(a,10)}):[],i=a('<button type="button" class="btn"><i class="icon-trash"></i>Clear</button>'),j=a("<canvas>"),k=j[0].getContext("2d"),l=new Image,q=function(){j.attr("height",l.height).attr("width",l.width),m()},a(l).load(q),l.src=h.imageUrl,l.loaded&&q(),j.css({background:"url("+l.src+")"}),a(document).ready(function(){a(d).after("<br>",j,"<br>",i),i.click(r),j.on("mousedown",n),j.on("contextmenu",s),j.on("mouseup",o)}),r=function(){f=[],m()},p=function(b){b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top),f[g]=Math.round(b.offsetX),f[g+1]=Math.round(b.offsetY),m()},o=function(){a(this).off("mousemove"),t(),g=null},s=function(b){b.preventDefault(),b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top);for(var c=b.offsetX,d=b.offsetY,e=0;e<f.length;e+=2)if(dis=Math.sqrt(Math.pow(c-f[e],2)+Math.pow(d-f[e+1],2)),6>dis)return f.splice(e,2),m(),t(),!1;return!1},n=function(b){var d,e,h,i,j=f.length;if(3===b.which)return!1;b.preventDefault(),b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top),d=b.offsetX,e=b.offsetY;for(var k=0;k<f.length;k+=2)if(h=Math.sqrt(Math.pow(d-f[k],2)+Math.pow(e-f[k+1],2)),6>h)return g=k,a(this).on("mousemove",p),!1;for(var k=0;k<f.length;k+=2)k>1&&(i=c(d,e,f[k],f[k+1],f[k-2],f[k-1],!0),6>i&&(j=k));return f.splice(j,0,Math.round(d),Math.round(e)),g=j,a(this).on("mousemove",p),m(),t(),!1},m=function(){if(k.canvas.width=k.canvas.width,t(),f.length<2)return!1;k.globalCompositeOperation="destination-over",k.fillStyle="rgb(255,255,255)",k.strokeStyle="rgb(255,20,20)",k.lineWidth=1,k.beginPath(),k.moveTo(f[0],f[1]);for(var a=0;a<f.length;a+=2)k.fillRect(f[a]-2,f[a+1]-2,4,4),k.strokeRect(f[a]-2,f[a+1]-2,4,4),f.length>2&&a>1&&k.lineTo(f[a],f[a+1]);k.closePath(),k.fillStyle="rgba(255,0,0,0.3)",k.fill(),k.stroke()},t=function(){a(d).val(f.join(","))},a(d).on("change",function(){f=a(d).val(),m()})};a(document).ready(function(){a(".canvas-area[data-image-url]").canvasAreaDraw()});var c=function(a,b,c,d,e,f,g){function h(a,b,c,d){return Math.sqrt((a-=c)*a+(b-=d)*b)}if(!g||(g=function(a,b,c,d,e,f){if(!(e-c))return{x:c,y:b};if(!(f-d))return{x:a,y:d};var g,h=-1/((f-d)/(e-c));return{x:g=(e*(a*h-b+d)+c*(a*-h+b-f))/(h*(e-c)+d-f),y:h*g-h*a+b}}(a,b,c,d,e,f),g.x>=Math.min(c,e)&&g.x<=Math.max(c,e)&&g.y>=Math.min(d,f)&&g.y<=Math.max(d,f))){var i=d-f,j=e-c,k=c*f-d*e;return Math.abs(i*a+j*b+k)/Math.sqrt(i*i+j*j)}var l=h(a,b,c,d),m=h(a,b,e,f);return l>m?m:l}}(jQuery);